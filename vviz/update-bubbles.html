<!-- Reference:
https://bl.ocks.org/HarryStevens/54d01f118bc8d1f2c4ccd98235f33848 -->
<html>

<head>
    <style>
        body {
            margin: 0;
            font-family: "Helvetica", sans-serif;

            

        }

        text {
            text-anchor: middle;
            fill: #fff;
        }
        .scroll-position{
          position: fixed;
        }

        .background{
          position: fixed;
          height:100vh;
          width:100vw;
          background: linear-gradient(180deg, #050614 0%, #041D59 100%);
        }
    </style>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
</head>

<body>
  <div class="background">
    <div class="scroll-position" data-0="background:white" data-2320="background:white">
      2004
    </div>
  </div>
    <script src="https://d3js.org/d3.v4.min.js"></script>
    <script src="https://unpkg.com/jeezy@1.11.2/lib/jeezy.min.js"></script>
    <script src='https://cdnjs.cloudflare.com/ajax/libs/skrollr/0.6.30/skrollr.min.js'></script>

    <script>
        var alphabet = [];
        $.getJSON("/vviz/data.json", function(json){
          alphabet=json;
          redraw(randomizeData());
        })

        var year = 2004;

        var width = window.innerWidth, height = window.innerHeight;

        var svg = d3.select("body").append("svg").attr("width", width).attr("height", height).style("position","fixed");

        var pack = d3.pack()
            .size([width, height])
            .padding(1.5);


        function redraw(classes) {

            // transition
            var t = d3.transition()
                .duration(750);

            // hierarchy
            var h = d3.hierarchy({ children: classes })
                .sum(function (d) { return d.size; })

            //JOIN
            var circle = svg.selectAll("circle")
                .data(pack(h).leaves(), function (d) { return d.data.name; });

            var text = svg.selectAll("text")
                .data(pack(h).leaves(), function (d) { return d.data.name; });

            //EXIT
            circle.exit()
                .transition(t)
                .attr("r", 1e-6)
                .remove();

            text.exit()
                .transition(t)
                .remove();

            //UPDATE
            circle
                .transition(t)
                .attr("r", function (d) { return d.r })
                .attr("cx", function (d) { return d.x; })
                .attr("cy", function (d) { return d.y; })

            text
                .transition(t)
                .attr("x", function (d) { return d.x; })
                .attr("y", function (d) { return d.y; })
                .style("display", function(d) {if (d.r<50){console.log("UPDATE", d); return "none";}});

            //ENTER
            circle.enter().append("circle")
                .attr("r", 1e-6)
                .attr("cx", function (d) { return d.x; })
                .attr("cy", function (d) { return d.y; })
                .style("fill", function(d){return d.data.color})
                .transition(t)
                .attr("r", function (d) { return d.r })
                .attr("cclass",function(d) {return d.data.size});

            text.enter().append("text")
                .attr("x", function (d) { return d.x; })
                .attr("y", function (d) { return d.y; })
                .text(function (d) { return d.data.name; })
                .transition(t)
                .style("display", function(d) {if (d.r<50){console.log("ENTER", d); return "none";}});
        }

        function randomizeData() {
            
            
            var d1 = alphabet.sort((a,b) => (b[year] - a[year])).slice(0,40);
            var d2 = [];

            d1.forEach(function (d) {
                var ccolor = "#0495f8";
                if (d.Category == "Grooming") {ccolor = "#8505cb"};
                if (d.Category == "Beard") {ccolor = "#d6006d"};
                d2.push({ name: d.Keyword, size: d[year], color: ccolor })
            });
            return d2;
            
        }

    </script>
    <script>
        var s = skrollr.init({ smoothScrolling: false, smoothScrollingDuration: 1500  });


        function debounce(method, delay) {
            clearTimeout(method._tId);
            method._tId = setTimeout(function () {
                method();
            }, delay);
        }

        function handleScroll(){
            console.log("Scrolling");
            year = Math.round($(window).scrollTop()/145 + 2004);
            $('.scroll-position').text(year);
            console.log($(window).scrollTop());
            redraw(randomizeData());
        }

        window.onscroll = function (e) {
            debounce(handleScroll, 100);
        };
    </script>
</body>

</html>